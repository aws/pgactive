  [BDR 2.0.7 Documentation](README.md)                                                                                                                   
  ----------------------------------------------------------------------- ----------------------------------- ------------------------------------------- ----------------------------------------------------------------
  [Prev](x4421.md "Upgrading 2.0.x to 2.0.y releases")   [Up](upgrade.md)    Chapter 14. Upgrading [BDR]    [Next](x4537.md "Upgrading BDR 0.9.x to 1.0")  


# 14.2. Upgrading BDR 1.0 to BDR 2.0 and Postgres-BDR 9.4 to PostgreSQL 9.6

Users of BDR 1.0 running on Postgres-BDR 9.4 should upgrade to BDR 2.0
on Postgres-BDR 9.4, and then to BDR 2.0 on PostgreSQL 9.6.

> **Important:** Do not attempt to upgrade from BDR 1.0 on Postgres-9.4
> directly to BDR 2.0 on PostgreSQL 9.6. It will not work. There is no
> support for [pg_upgrade]\'ing Postgres-9.4 to PostgreSQL
> 9.6, the data directories are not compatible, and BDR 2.0 cannot join
> a BDR 1.0 group. You must upgrade via BDR 2.0 on Postgres-BDR 9.4.

## 14.2.1. Offline upgrade

If your deployment does not use BDR 1.0 global sequences, or you plan to
adjust your sequence setup after you upgrade to BDR 2.0 on 9.6, you can
perform a direct offline upgrade from BDR 1.0 on 9.4 to BDR 2.0 on 9.6
using a dump and reload.

> **Important:** Check to ensure you are not using BDR 1.0 global
> sequences before upgrading, or at least list them so you know which
> seqences will need fixing after you upgrade. See [BDR 1.0 Global
> Sequences](global-sequences-bdr10.md) and [Converting BDR 1.0 global
> sequences](x4424.md#UPGRADE-20-CONVERT-10-GLOBAL-SEQUENCES).

To prepare to upgrade, first tear down BDR and restore your system to a
single standalone node using
[`bdr.bdr_remove()`](node-management-disabling.md).
Make sure you `DROP EXTENSION bdr;` and remove `bdr`
from `shared_preload_libraries` and restart the PostgreSQL
instance.

Then, like any other nontrivial server migration by dump and reload, you
should `pg_dumpall --globals-only` then
`pg_dump -Fc -T 'bdr.*'` each database you wish to migrate.

> **Important:** If you use a dump and reload to upgrade, use the
> [pg_dump] and [pg_restore] from PostgreSQL
> 9.6, [*not*] the ones from Postgres-BDR 9.4.

Once your database is restored to PostgreSQL 9.6, bring up BDR as if
this were a new setup, join new nodes, then make any required fixes to
your sequences such as switching `DEFAULT`s on your tables to
use [bdr.bdr_snowflake_id_nextval(\...)](global-sequences.md) or setting up
step/offset sequences on your nodes.

## 14.2.2. Online upgrade

### 14.2.2.1. Online upgrade limitations

While the 1.0 to 2.0 upgrade does not require extended downtime, a
restart of each node is absolutely [*required*].

It is recommended that all nodes be upgraded at roughly the same time,
because the 1.0 and 2.0 catalogs are not entirely compatible so nodes
cannot part or join while the BDR group contains a mixture of 1.0 and
2.0 nodes, DDL replication won\'t work, etc.

If a user or application attempts to enqueue DDL from a 1.0 node after
some nodes have been upgraded to 2.0, the 2.0 nodes will be unable to
replay the DDL. To protect against this it is [*strongly*]
recommended that the option
[`bdr.permit_ddl_locking = on`](bdr-configuration-variables.md#GUC-BDR-PERMIT-DDL-LOCKING)
be set in `postgresql.conf` so that attempts to execute DDL
will fail. Don\'t forget to `SELECT pg_reload_conf()` or
`pg_ctl reload` after changing the setting.

A mixed BDR 1.0 and BDR 2.0 group can be operated safely for a
transition period so long as no nodes need to part or join, and no DDL
needs to be performed. (It is [*not*] safe to mix in 2.0
nodes running on PostgreSQL 9.6 if global sequences are in use, though).

There is no support for BDR 2.0 nodes joining a 1.0 group or vice versa.
If you require such support it is possible to add it as an update to BDR
1.0. [Contact 2ndQuadrant](http://2ndquadrant.com) if
this important to your business.

### 14.2.2.2. Upgrading the BDR extension from 1.x to 2.0

To online-upgrade the BDR extension on each node, simply install the 2.0
extension into your PostgreSQL instance the same way you installed 1.0.
This may be from source code, rpm/deb package, etc. Then [*restart
PostgreSQL*]. Do [*NOT*] attempt to
`ALTER EXTENSION bdr UPDATE`.

BDR will notice the new extension files and update the extension. To
confirm, check the output of:

``` PROGRAMLISTING
       SELECT extname, extversion FROM pg_extension WHERE extname = 'bdr'
     
```

and

``` PROGRAMLISTING
       SELECT bdr.vdr_version();
     
```

Once all nodes are upgraded, run the post-upgrade script on
[*one*] node. It does not matter which node.

``` PROGRAMLISTING
       SELECT bdr.bdr_assign_seq_ids_post_upgrade();
     
```

### 14.2.2.3. Converting BDR 1.0 global sequences

BDR 1.0-style global sequences, created with the `USING bdr`
syntax to `CREATE SEQUENCE`, are [*not*] supported
by BDR 2.0 on PostgreSQL 9.6. Nor are they likely to be supported by
future PostgreSQL releases, as the underlying functionality required to
intercept sequence operations and redirect them was not incorporated
into community PostgreSQL.

To check whether you are using BDR 1.0 global sequences, and where, see
[BDR 1.0 Global Sequences](global-sequences-bdr10.md).

BDR 2.0 continues to support BDR 1.0-style global sequences on
BDR-Postgres 9.4. However, users are advised to convert to BDR 2.0
global sequences because unlike the 1.0-style sequences they are immune
to network partition related faults and they cannot suffer temporary
exhaustion when consumed too fast. There are downsides too, so make sure
to read the [global sequences](global-sequences.md) chapter.
[*Application changes or configuration may be necessary.*]

BDR 2.0 global sequences require `bigint` storage. So the
first step is to widen any `integer` columns to `bigint`.
This requires multiple steps and [*[cannot be done with
`ALTER TABLE ... ALTER COLUMN ... TYPE ...`](ddl-replication-statements.md#DDL-REPLICATION-RESTRICTED-COMMANDS)*].
See [Changing a column\'s
type](ddl-replication-statements.md#DDL-REPLICATION-ALTERTYPE).
Alternately, you may choose to [use step/offset
sequences](global-sequences-alternatives.md), which do not require
`bigint` storage, but need manual setup when nodes are added or
removed.

BDR 2.0 global sequences use a time-based generation algorithm. The
start values are not directly configurable, but will be greater than any
likely allocations from BDR 1.0 sequences in all but the most extreme
cases. Check to make sure your tables do not contain values greater than
those returned by the new sequences. If they do, you may need to use an
alternative method of sequence generation.

For each BDR 1.0 sequence, begin a transaction and

``` PROGRAMLISTING
     LOCK TABLE table_with_sequence IN EXCLUSIVE MODE;
     ALTER SEQUENCE the_sequence USING local;
     ALTER SEQUENCE the_sequence RESTART WITH 1;
     ALTER TABLE table_with_sequence ALTER COLUMN column_with_sequence DEFAULT bdr.bdr_snowflake_id_nextval('the_sequence');
     
```

then commit.

> **Important:** Verify that the new values generated by
> `bdr.bdr_snowflake_id_nextval` are greater than any that
> currently exist in the table before resuming normal operation. Make
> sure the application does not directly call `nextval` on
> the sequence, and that no other `DEFAULT`s elsewhere refer
> to the sequence.

### 14.2.2.4. Online-upgrading BDR 2.0 from Postgres-BDR 9.4 to PostgreSQL 9.6

When all nodes are running BDR 2.0 on Postgres-BDR 9.4 and all use of
BDR 1.0 global sequences has been retired, it is possible to upgrade BDR
to run on PostgreSQL 9.6. The PostgreSQL version upgrade is an online
upgrade performed while the BDR group continues to process normal
loads - but DDL should be avoided if possible.

  **Warning**
  A BDR 2.0 instance running on PostgreSQL 9.6 will refuse to join a BDR-Postgres 9.4 based group if any BDR 1.0 global sequences are found. Make sure you convert your sequences first.

There is no [pg_upgrade] support for upgrading
Postgres-BDR 9.4 to PostgreSQL 9.6. Upgrades are accomplished by joining
new 9.6-based BDR nodes to the BDR group, then parting the old 9.4-based
nodes.

DDL performed on 9.6 nodes may not apply correctly on 9.4 nodes, since
new features have been added to PostgreSQL 9.6. For that reason it is
recommended that [*at least*] on the 9.6 nodes,
[`bdr.permit_ddl_locking = on`](bdr-configuration-variables.md#GUC-BDR-PERMIT-DDL-LOCKING)
is set until the last 9.4 node has been parted.

Because [bdr_init_replica] does a physical copy with
[pg_basebackup] it cannot be used to join the first 9.6
node to a running 9.4 BDR group. A logical join using
[`bdr.bdr_join_group`](functions-node-mgmt.md#FUNCTION-BDR-JOIN-GROUP)
must be performed. See [Joining a node](node-management-joining.md).

Once the first 9.6 node is joined, subsequent 9.6 nodes may be added to
replace 9.4 nodes either by using `bdr.bdr_join_group`
targeting any node (9.4 or 9.6), or by using
[bdr_init_copy] targeting a 9.6 node. Which is the best
choice for you depends on your network.

An upgrade may be done on a rolling basis, by adding a 9.6 node then
removing the corresponding 9.4 node. Or it may be done by adding all 9.6
nodes then parting all 9.4 nodes. Which is the best choice depends on
your network.

It may be possible to add [pg_upgrade] support for
upgrading Postgres-BDR 9.4 to PostgreSQL 9.6 in-place. If this is
important for your deployment, please [contact
2ndQuadrant](http://2ndquadrant.com).



  ----------------------------------- ----------------------------------- -----------------------------------
  [Prev](x4421.md)    [Home](README.md)    [Next](x4537.md)  
  Upgrading 2.0.x to 2.0.y releases    [Up](upgrade.md)           Upgrading BDR 0.9.x to 1.0
  ----------------------------------- ----------------------------------- -----------------------------------
