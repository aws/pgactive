<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Monitoring replication peers</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto: bdr-list@2ndquadrant.com"><LINK
REL="HOME"
TITLE="BDR 2.0.6 Documentation"
HREF="index.html"><LINK
REL="UP"
TITLE="Monitoring"
HREF="monitoring.html"><LINK
REL="PREVIOUS"
TITLE="Monitoring node join/removal"
HREF="monitoring-node-join-remove.html"><LINK
REL="NEXT"
TITLE="Monitoring global DDL locks"
HREF="monitoring-ddl-lock.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="website-docs.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=ISO-8859-1"><META
NAME="creation"
CONTENT="2023-04-11T13:16:52"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>BDR 2.0.6 Documentation</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="Monitoring node join/removal"
HREF="monitoring-node-join-remove.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="monitoring.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>Chapter 7. Monitoring</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="Monitoring global DDL locks"
HREF="monitoring-ddl-lock.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="MONITORING-PEERS"
>7.3. Monitoring replication peers</A
></H1
><P
>   As outlined in <A
HREF="monitoring-why.html"
>Why monitoring matters</A
> it is important to monitor
   the state of peer nodes in a BDR group. There are two main views
   used for this: <TT
CLASS="LITERAL"
>pg_stat_replication</TT
> to monitor for
   actively replicating nodes, and <TT
CLASS="LITERAL"
>pg_replication_slots</TT
>
   to monitor for replication slot progress.
  </P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MONITORING-CONNECTIONS"
>7.3.1. Monitoring connected peers using pg_stat_replication</A
></H2
><P
>    Administrators may query
    <A
HREF="http://www.postgresql.org/docs/current/static/monitoring-stats.html#PG-STAT-REPLICATION-VIEW"
TARGET="_top"
>pg_catalog.pg_stat_replication</A
>
    to monitor actively replicating connections.
    It shows the pid of the local side of the connection (wal sender process), the
    application name sent by the peer (for BDR, this is <TT
CLASS="LITERAL"
>bdr
    (sysid,timeline,dboid,)</TT
>), and other status information:
    </P><PRE
CLASS="PROGRAMLISTING"
>    SELECT * FROM pg_stat_replication;
      pid  | usesysid | usename |              application_name              | client_addr | client_hostname | client_port |         backend_start         | backend_xmin |   state   | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state
    -------+----------+---------+--------------------------------------------+-------------+-----------------+-------------+-------------------------------+--------------+-----------+---------------+----------------+----------------+-----------------+---------------+------------
     29045 |    16385 | myadmin   | bdr (6127682459268878512,1,16386,):receive |             |                 |          -1 | 2015-03-18 21:03:28.717175+00 |              | streaming | 0/189D3B8     | 0/189D3B8      | 0/189D3B8      | 0/189D3B8       |             0 | async
     29082 |    16385 | myadmin   | bdr (6127682494973391064,1,16386,):receive |             |                 |          -1 | 2015-03-18 21:03:44.665272+00 |              | streaming | 0/189D3B8     | 0/189D3B8      | 0/189D3B8      | 0/189D3B8       |             0 | async
    </PRE
><P>
    This view shows all active replication connections, not just those used by
    BDR. You will see connections from physical streaming replicas, other
    logical decoding solutions, etc here as well.
   </P
><P
>    To tell how far behind a given active connection is, compare its
    <TT
CLASS="LITERAL"
>flush_location</TT
> (the replay position up to which
    it has committed its work) with the sending server's
    <TT
CLASS="LITERAL"
>pg_current_xlog_insert_location()</TT
> using
    <TT
CLASS="LITERAL"
>pg_xlog_location_diff</TT
>, e.g:
    </P><PRE
CLASS="PROGRAMLISTING"
>     SELECT
       pg_xlog_location_diff(pg_current_xlog_insert_location(), flush_location) AS lag_bytes,
       pid, application_name
     FROM pg_stat_replication;
    </PRE
><P>
    This query will show how much lag downstream servers have from the upstream
    server you run the query on. You can't use this to see, from the downstream
    server, how far it is behind an upstream it's receiving from.
    Also, the query will show lag for all replication consumers, including non-BDR
    ones. To show only BDR peers, append
    <TT
CLASS="LITERAL"
>WHERE application_name LIKE 'bdr%'</TT
>.
   </P
><DIV
CLASS="WARNING"
><P
></P
><TABLE
CLASS="WARNING"
BORDER="1"
WIDTH="100%"
><TR
><TD
ALIGN="CENTER"
><B
>Warning</B
></TD
></TR
><TR
><TD
ALIGN="LEFT"
><P
>     <TT
CLASS="LITERAL"
>pg_stat_replication</TT
> does <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>not</I
></SPAN
> show
     peers that have a slot but are not currently connected, even though such
     peers are still making the server retain WAL. It is important to monitor
     <TT
CLASS="LITERAL"
>pg_replication_slots</TT
> too.
    </P
></TD
></TR
></TABLE
></DIV
><P
>    There is not currently any facility to report how far behind a given node
    is in elapsed seconds of wall-clock time. So you can't easily tell that
    node <TT
CLASS="REPLACEABLE"
><I
>X</I
></TT
> currently has data that is
    <TT
CLASS="REPLACEABLE"
><I
>n</I
></TT
> seconds older than the original data on node
    <TT
CLASS="REPLACEABLE"
><I
>Y</I
></TT
>. If this is an application requirement the
    application should write periodic timestamp tick records to a table and
    check how old the newest tick for a given node is on other nodes.
   </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MONITORING-SLOTS"
>7.3.2. Monitoring replication slots</A
></H2
><P
>	Information about replication slots (both logical and physical) is
	available in the <TT
CLASS="LITERAL"
>pg_catalog.pg_replication_slots</TT
> view.
  This view shows all slots, whether or not there is an active replication
  connection using them. It looks like:
    </P><PRE
CLASS="PROGRAMLISTING"
>    SELECT * FROM pg_replication_slots;
                    slot_name                | plugin | slot_type | datoid | database | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn 
    -----------------------------------------+--------+-----------+--------+----------+--------+------------+------+--------------+-------------+---------------------
     bdr_16386_6127682459268878512_1_16386__ | bdr    | logical   |  16386 | bdrdemo  | t      |       4121 |      |          749 | 0/191B130   | 0/201E120
     bdr_16386_6127682494973391064_1_16386__ | bdr    | logical   |  16386 | bdrdemo  | t      |       4317 |      |          749 | 0/191B130   | 0/201E120
    (2 rows)
    </PRE
><P>
    If a slot has <TT
CLASS="LITERAL"
>active = t</TT
>
    then there will be a corresponding <TT
CLASS="LITERAL"
>pg_stat_replication</TT
> entry
    for the walsender process connected to the slot.
   </P
><P
>    This view shows only replication peers that use a slot. Physical streaming
    replication connections that don't use slots will not show up here, only in
    <TT
CLASS="LITERAL"
>pg_stat_replication</TT
>. BDR always uses slots so all
    BDR peers will appear here.
   </P
><P
>    If you want to see a combined view, you can query a join of the two:
	</P><PRE
CLASS="PROGRAMLISTING"
>	SELECT *
	FROM pg_catalog.pg_stat_replication r
	FULL OUTER JOIN pg_catalog.pg_replication_slots s
	             ON r.pid = s.active_pid
	WHERE r.application_name IS NULL
	   OR r.application_name LIKE 'bdr%';
	</PRE
><P>
	This has the handy advantage of showing the replication slot name along
	with details of the walsender backend using the slot.
   </P
><P
>    To see how much extra <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
> BDR slot is asking the server
    to keep, in bytes, use a query like:
    </P><PRE
CLASS="PROGRAMLISTING"
>    SELECT
      slot_name, database, active, active_pid
      pg_xlog_location_diff(pg_current_xlog_insert_location(), restart_lsn) AS retained_bytes
    FROM pg_catalog.pg_replication_slots
    WHERE plugin = 'bdr';
    </PRE
><P>
   </P
><P
>    Retained <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
> isn't additive; if you have three peers, who
    of which require 500KB of <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
> to be retained and one that
    requires 8MB, only 8MB is retained.  It's like a dynamic version of the
    <TT
CLASS="LITERAL"
>wal_keep_segments</TT
> setting (or, in 9.5,
    <TT
CLASS="LITERAL"
>min_wal_size</TT
>). So you need to monitor to make sure that
    the <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>largest</I
></SPAN
> amount of retained <ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
>
    doens't exhaust the free space in <TT
CLASS="FILENAME"
>pg_xlog</TT
> on each node.
   </P
><P
>    It is normal for <TT
CLASS="LITERAL"
>pg_replication_slots.restart_lsn</TT
> not to
    advance as soon as <TT
CLASS="LITERAL"
>pg_stat_replication.flush_location</TT
>
    advances on an active connection. The slot restat position does
    <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>not</I
></SPAN
> indicate how old the data you will see on a peer
    node is.
   </P
><P
>	<TT
CLASS="LITERAL"
>pg_replication_slots.confirmed_flush_lsn</TT
> is a better
	measure of replication progress, since it shows the position of the last
	commit the replica has written safely to disk. However, it will only
	advance when a transaction <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>completes</I
></SPAN
> replay and commits. If
	you monitor only <TT
CLASS="LITERAL"
>confirmed_flush_lsn</TT
>, replication will seem to
	stop making progress during transfer and apply of big transactions, wheras
	<TT
CLASS="LITERAL"
>pg_stat_replication.write_location</TT
>'s will continue to advance.
   </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MONITORING-WORKERS"
>7.3.3. Montitoring BDR workers</A
></H2
><P
>    All BDR workers (except the supervisor) show up in the system view
    <A
HREF="https://www.postgresql.org/docs/current/static/monitoring-stats.html#PG-STAT-ACTIVITY-VIEW"
TARGET="_top"
><TT
CLASS="LITERAL"
>pg_stat_activity</TT
></A
>
    so this view offers some insight into the state of a BDR system. There is
    always one <TT
CLASS="REPLACEABLE"
><I
>nodename</I
></TT
><TT
CLASS="LITERAL"
>:perdb</TT
> worker per BDR node.
    Each connection to another node adds one <TT
CLASS="REPLACEABLE"
><I
>othernodename</I
></TT
><TT
CLASS="LITERAL"
>:apply</TT
>
    entry for the local apply worker receiving and applying changes from that
    remote node, and one <TT
CLASS="REPLACEABLE"
><I
>othernodename</I
></TT
><TT
CLASS="LITERAL"
>:send</TT
>
    worker for the local walsender the remote apply worker is connected to.
   </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="monitoring-node-join-remove.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="monitoring-ddl-lock.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Monitoring node join/removal</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="monitoring.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Monitoring global DDL locks</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>