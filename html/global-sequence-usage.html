<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Using global sequences</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto: bdr-list@2ndquadrant.com"><LINK
REL="HOME"
TITLE="BDR 2.0.6 Documentation"
HREF="index.html"><LINK
REL="UP"
TITLE="Global Sequences"
HREF="global-sequences.html"><LINK
REL="PREVIOUS"
TITLE="When to use global sequences"
HREF="global-sequences-when.html"><LINK
REL="NEXT"
TITLE="Global sequence limitations"
HREF="global-sequence-limitations.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="website-docs.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=ISO-8859-1"><META
NAME="creation"
CONTENT="2023-04-11T13:16:52"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>BDR 2.0.6 Documentation</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="When to use global sequences"
HREF="global-sequences-when.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="global-sequences.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>Chapter 10. Global Sequences</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="Global sequence limitations"
HREF="global-sequence-limitations.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="GLOBAL-SEQUENCE-USAGE"
>10.3. Using global sequences</A
></H1
><P
>   To use a global sequence, create a local sequence with <TT
CLASS="LITERAL"
>CREATE
   SEQUENCE ...</TT
> like normal. Then instead of using
   <CODE
CLASS="FUNCTION"
>nextval(seqname)</CODE
> to get values from it, use
   <CODE
CLASS="FUNCTION"
>bdr.global_seq_nextval(seqname)</CODE
>. The destination
   column must be <TT
CLASS="TYPE"
>BIGINT</TT
> as the result is 64 bits wide.
   </P><PRE
CLASS="PROGRAMLISTING"
>   BEGIN;

    CREATE TABLE gstest (
      id bigint primary key,
      parrot text
    );

    CREATE SEQUENCE gstest_id_seq OWNED BY gstest.id;

    ALTER TABLE gstest ALTER COLUMN id SET DEFAULT bdr.global_seq_nextval('gstest_id_seq');
   
   </PRE
><P>
  </P
><P
>   If you normally create the sequence as a <TT
CLASS="TYPE"
>BIGSERIAL</TT
> column you
   may continue to do so. To enable global sequence use on the column you must
   <TT
CLASS="LITERAL"
>ALTER</TT
> the <TT
CLASS="LITERAL"
>DEFAULT</TT
> expression after
   table creation. There is currently no facility to do this automatically and
   transparently so you need to do it in a follow up command like:
   </P><PRE
CLASS="PROGRAMLISTING"
>    ALTER TABLE my_table ALTER COLUMN my_bigserial SET DEFAULT bdr.global_seq_nextval('my_table_my_bigserial_seq');
   </PRE
><P>
  </P
><P
>   <TT
CLASS="LITERAL"
>SERIAL</TT
> must be converted to <TT
CLASS="LITERAL"
>BIGSERIAL</TT
> since 32-bit
   wide global sequence values are not supported.
  </P
><DIV
CLASS="WARNING"
><P
></P
><TABLE
CLASS="WARNING"
BORDER="1"
WIDTH="100%"
><TR
><TD
ALIGN="CENTER"
><B
>Warning</B
></TD
></TR
><TR
><TD
ALIGN="LEFT"
><P
>    Do not add a <TT
CLASS="TYPE"
>BIGSERIAL</TT
> column to an existing non-empty table,
    either directly or using <TT
CLASS="LITERAL"
>bdr.replicate_ddl_command</TT
>.  Instead
    follow the advice for adding columns in the <A
HREF="ddl-replication.html"
>DDL replication</A
> chapter. If default values are assigned during
    <TT
CLASS="LITERAL"
>ALTER TABLE ... ADD COLUMN ...</TT
> rather than by a follow-up
    <TT
CLASS="LITERAL"
>UPDATE</TT
> the order of value assignment may differ from node to
    node, leading to inconsistencies. Additionally, the sequence values will be
    assigned before you can switch to using <TT
CLASS="LITERAL"
>bdr.global_seq_nextval</TT
>.
   </P
></TD
></TR
></TABLE
></DIV
><P
>   Global sequences are handled normally by <SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>. Because
   the <TT
CLASS="LITERAL"
>DEFAULT</TT
> is <TT
CLASS="LITERAL"
>bdr.global_seq_nextval(...)</TT
>, the
   <TT
CLASS="LITERAL"
>bdr</TT
> schema must exist on the node targeted for restoration.
  </P
><P
>   Global sequences work on one or more nodes and do not require any inter-node
   communication after the node join process completes. So they may continue to
   be used even if there's the risk of extended network partitions and are not
   affected by replication lag or inter-node latency.
  </P
><P
>   It's preferable to avoid calling <TT
CLASS="LITERAL"
>nextval</TT
> on a sequence
   that's used with <CODE
CLASS="FUNCTION"
>bdr.global_seq_nextval</CODE
>. Doing so won't
   cause any harm so long as the application doesn't try to mix the results of
   the two functions in the same column and expect them to be unique.
  </P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="global-sequences-when.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="global-sequence-limitations.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>When to use global sequences</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="global-sequences.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Global sequence limitations</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>