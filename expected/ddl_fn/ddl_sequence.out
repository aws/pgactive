--  ALTER TABLE public.DROP COLUMN (pk column)
SELECT bdr.bdr_replicate_ddl_command($DDL$ CREATE TABLE public.test (test_id SERIAL); $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\c postgres
\d+ test
                                                   Table "public.test"
 Column  |  Type   | Collation | Nullable |                Default                | Storage | Stats target | Description 
---------+---------+-----------+----------+---------------------------------------+---------+--------------+-------------
 test_id | integer |           | not null | nextval('test_test_id_seq'::regclass) | plain   |              | 

SELECT relname, relkind FROM pg_class WHERE relname = 'test_test_id_seq';
     relname      | relkind 
------------------+---------
 test_test_id_seq | S
(1 row)

\d+ test_test_id_seq
                  Sequence "public.test_test_id_seq"
  Type   | Start | Minimum |  Maximum   | Increment | Cycles? | Cache 
---------+-------+---------+------------+-----------+---------+-------
 integer |     1 |       1 | 2147483647 |         1 | no      |     1
Owned by: public.test.test_id

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER TABLE public.test  DROP COLUMN test_id; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\c regression
\d+ test
                                  Table "public.test"
 Column | Type | Collation | Nullable | Default | Storage | Stats target | Description 
--------+------+-----------+----------+---------+---------+--------------+-------------

SELECT relname, relkind FROM pg_class WHERE relname = 'test_test_id_seq';
 relname | relkind 
---------+---------
(0 rows)

SELECT bdr.bdr_replicate_ddl_command($DDL$ DROP TABLE public.test; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

-- ADD CONSTRAINT PRIMARY KEY
SELECT bdr.bdr_replicate_ddl_command($DDL$ CREATE TABLE public.test (test_id SERIAL NOT NULL); $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\c postgres
\d+ test
                                                   Table "public.test"
 Column  |  Type   | Collation | Nullable |                Default                | Storage | Stats target | Description 
---------+---------+-----------+----------+---------------------------------------+---------+--------------+-------------
 test_id | integer |           | not null | nextval('test_test_id_seq'::regclass) | plain   |              | 

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER TABLE public.test ADD CONSTRAINT test_pkey PRIMARY KEY (test_id); $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\c regression
\d+ test
                                                   Table "public.test"
 Column  |  Type   | Collation | Nullable |                Default                | Storage | Stats target | Description 
---------+---------+-----------+----------+---------------------------------------+---------+--------------+-------------
 test_id | integer |           | not null | nextval('test_test_id_seq'::regclass) | plain   |              | 
Indexes:
    "test_pkey" PRIMARY KEY, btree (test_id)

SELECT bdr.bdr_replicate_ddl_command($DDL$ DROP TABLE public.test; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\c postgres
-- normal sequence
SELECT bdr.bdr_replicate_ddl_command($DDL$ CREATE SEQUENCE public.test_seq increment 10; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\d+ test_seq
                          Sequence "public.test_seq"
  Type  | Start | Minimum |       Maximum       | Increment | Cycles? | Cache 
--------+-------+---------+---------------------+-----------+---------+-------
 bigint |     1 |       1 | 9223372036854775807 |        10 | no      |     1

\c postgres
\d+ test_seq
                          Sequence "public.test_seq"
  Type  | Start | Minimum |       Maximum       | Increment | Cycles? | Cache 
--------+-------+---------+---------------------+-----------+---------+-------
 bigint |     1 |       1 | 9223372036854775807 |        10 | no      |     1

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER SEQUENCE public.test_seq increment by 10; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER SEQUENCE public.test_seq minvalue 0; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER SEQUENCE public.test_seq maxvalue 1000000; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER SEQUENCE public.test_seq restart; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER SEQUENCE public.test_seq cache 10; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER SEQUENCE public.test_seq cycle; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ ALTER SEQUENCE public.test_seq RENAME TO renamed_test_seq; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\d+ test_seq
\d+ renamed_test_seq
                Sequence "public.renamed_test_seq"
  Type  | Start | Minimum | Maximum | Increment | Cycles? | Cache 
--------+-------+---------+---------+-----------+---------+-------
 bigint |     1 |       0 | 1000000 |        10 | yes     |    10

\c regression
\d+ test_seq
\d+ renamed_test_seq
                Sequence "public.renamed_test_seq"
  Type  | Start | Minimum | Maximum | Increment | Cycles? | Cache 
--------+-------+---------+---------+-----------+---------+-------
 bigint |     1 |       0 | 1000000 |        10 | yes     |    10

\c postgres
SELECT bdr.bdr_replicate_ddl_command($DDL$ DROP SEQUENCE public.renamed_test_seq; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\d+ renamed_test_seq;
\c regression
\d+ renamed_test_seq
SELECT bdr.bdr_replicate_ddl_command($DDL$ CREATE SEQUENCE public.test_seq; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

-- DESTINATION COLUMN TYPE REQUIRED BIGINT
SELECT bdr.bdr_replicate_ddl_command($DDL$ DROP TABLE IF EXISTS public.test_tbl; $DDL$);
NOTICE:  table "test_tbl" does not exist, skipping
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ CREATE TABLE public.test_tbl (a int DEFAULT bdr.bdr_snowflake_id_nextval('public.test_seq'),b text); $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\d+ test_tbl
                                                       Table "public.test_tbl"
 Column |  Type   | Collation | Nullable |                      Default                       | Storage  | Stats target | Description 
--------+---------+-----------+----------+----------------------------------------------------+----------+--------------+-------------
 a      | integer |           |          | bdr.bdr_snowflake_id_nextval('test_seq'::regclass) | plain    |              | 
 b      | text    |           |          |                                                    | extended |              | 

\c postgres
\d+ test_tbl
                                                       Table "public.test_tbl"
 Column |  Type   | Collation | Nullable |                      Default                       | Storage  | Stats target | Description 
--------+---------+-----------+----------+----------------------------------------------------+----------+--------------+-------------
 a      | integer |           |          | bdr.bdr_snowflake_id_nextval('test_seq'::regclass) | plain    |              | 
 b      | text    |           |          |                                                    | extended |              | 

INSERT INTO test_tbl(b) VALUES('abc');
ERROR:  integer out of range
SELECT count(*) FROM test_tbl;
 count 
-------
     0
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ DROP TABLE public.test_tbl; $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ CREATE TABLE public.test_tbl (a bigint DEFAULT bdr.bdr_snowflake_id_nextval('public.test_seq'),b text); $DDL$);
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\d+ test_tbl
                                                       Table "public.test_tbl"
 Column |  Type  | Collation | Nullable |                      Default                       | Storage  | Stats target | Description 
--------+--------+-----------+----------+----------------------------------------------------+----------+--------------+-------------
 a      | bigint |           |          | bdr.bdr_snowflake_id_nextval('test_seq'::regclass) | plain    |              | 
 b      | text   |           |          |                                                    | extended |              | 

\c postgres
\d+ test_tbl
                                                       Table "public.test_tbl"
 Column |  Type  | Collation | Nullable |                      Default                       | Storage  | Stats target | Description 
--------+--------+-----------+----------+----------------------------------------------------+----------+--------------+-------------
 a      | bigint |           |          | bdr.bdr_snowflake_id_nextval('test_seq'::regclass) | plain    |              | 
 b      | text   |           |          |                                                    | extended |              | 

INSERT INTO test_tbl(b) VALUES('abc');
SELECT count(*) FROM test_tbl;
 count 
-------
     1
(1 row)

SELECT bdr.bdr_replicate_ddl_command($DDL$ DROP SEQUENCE public.test_seq CASCADE; $DDL$);
NOTICE:  drop cascades to default value for column a of table public.test_tbl
 bdr_replicate_ddl_command 
---------------------------
 
(1 row)

SELECT bdr.bdr_wait_for_slots_confirmed_flush_lsn(NULL,NULL);
 bdr_wait_for_slots_confirmed_flush_lsn 
----------------------------------------
 
(1 row)

\d+ test_tbl
                                 Table "public.test_tbl"
 Column |  Type  | Collation | Nullable | Default | Storage  | Stats target | Description 
--------+--------+-----------+----------+---------+----------+--------------+-------------
 a      | bigint |           |          |         | plain    |              | 
 b      | text   |           |          |         | extended |              | 

\c regression
\d+ test_tbl
                                 Table "public.test_tbl"
 Column |  Type  | Collation | Nullable | Default | Storage  | Stats target | Description 
--------+--------+-----------+----------+---------+----------+--------------+-------------
 a      | bigint |           |          |         | plain    |              | 
 b      | text   |           |          |         | extended |              | 

