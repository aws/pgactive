-- Allow commands via ALTER SYSTEM SET, config file, ALTER DATABASE set, etc
ALTER SYSTEM
  SET bdr.skip_ddl_locking = on;
ALTER SYSTEM
  SET bdr.skip_ddl_replication = on;
ALTER SYSTEM
  SET bdr.permit_unsafe_ddl_commands = on;
-- The check for per-database settings only occurs when you're on that
-- database, so we don't block the setting on another DB and the user
-- has to undo it later.
SELECT current_database();
 current_database 
------------------
 regression
(1 row)

-- Should be ok
ALTER DATABASE postgres
  SET bdr.skip_ddl_locking = on;
-- Should fail
ALTER DATABASE postgres
  SET bdr.skip_ddl_locking = off;
WARNING:  unsafe BDR configuration options can not be disabled locally
DETAIL:  The bdr options bdr.skip_ddl_locking and bdr.skip_ddl_replication should only be disabled globally.
HINT:  See the manual for information on these options. Using them without care can break replication.
ERROR:  invalid value for parameter "bdr.skip_ddl_locking": 0
-- An ERROR setting a GUC doesn't stop the connection to the DB
-- from succeeding though.
\c postgres
SELECT current_database();
 current_database 
------------------
 postgres
(1 row)

ALTER DATABASE postgres
  RESET bdr.skip_ddl_locking;
\c postgres
SELECT current_database();
 current_database 
------------------
 postgres
(1 row)

\c regression
SELECT current_database();
 current_database 
------------------
 regression
(1 row)

-- This is true even when you ALTER the current database, so this
-- commits fine, but switching back to the DB breaks:
ALTER DATABASE regression
  SET bdr.skip_ddl_replication = off;
WARNING:  unsafe BDR configuration options can not be disabled locally
DETAIL:  The bdr options bdr.skip_ddl_locking and bdr.skip_ddl_replication should only be disabled globally.
HINT:  See the manual for information on these options. Using them without care can break replication.
ERROR:  invalid value for parameter "bdr.skip_ddl_replication": 0
\c postgres
SELECT current_database();
 current_database 
------------------
 postgres
(1 row)

-- so this will report an error, but we'll still successfully connect to the DB.
\c regression
SELECT current_database();
 current_database 
------------------
 regression
(1 row)

-- and fix the GUC
ALTER DATABASE regression
  RESET bdr.skip_ddl_locking;
\c regression
SELECT current_database();
 current_database 
------------------
 regression
(1 row)

-- Fixed.
-- Explicit "off" is Not OK
ALTER DATABASE regression
  SET bdr.skip_ddl_locking = off;
WARNING:  unsafe BDR configuration options can not be disabled locally
DETAIL:  The bdr options bdr.skip_ddl_locking and bdr.skip_ddl_replication should only be disabled globally.
HINT:  See the manual for information on these options. Using them without care can break replication.
ERROR:  invalid value for parameter "bdr.skip_ddl_locking": 0
-- Unless at the system level
ALTER SYSTEM
  SET bdr.skip_ddl_locking = off;
ALTER SYSTEM
  RESET bdr.skip_ddl_locking;
-- Per-user is OK
ALTER USER super
  SET bdr.skip_ddl_replication = on;
-- Unless not permitted
ALTER USER super
  SET bdr.skip_ddl_replication = off;
WARNING:  unsafe BDR configuration options can not be disabled locally
DETAIL:  The bdr options bdr.skip_ddl_locking and bdr.skip_ddl_replication should only be disabled globally.
HINT:  See the manual for information on these options. Using them without care can break replication.
ERROR:  invalid value for parameter "bdr.skip_ddl_replication": 0
ALTER USER super
  RESET bdr.skip_ddl_replication;
-- Per session is OK
SET bdr.permit_unsafe_ddl_commands = on;
SET bdr.permit_unsafe_ddl_commands = off;
SET bdr.skip_ddl_replication = on;
SET bdr.skip_ddl_locking = on;
SET bdr.permit_ddl_locking = off;
-- Unless values are not permitted
SET bdr.skip_ddl_replication = off;
WARNING:  unsafe BDR configuration options can not be disabled locally
DETAIL:  The bdr options bdr.skip_ddl_locking and bdr.skip_ddl_replication should only be disabled globally.
HINT:  See the manual for information on these options. Using them without care can break replication.
ERROR:  invalid value for parameter "bdr.skip_ddl_replication": 0
SET bdr.skip_ddl_locking = off;
WARNING:  unsafe BDR configuration options can not be disabled locally
DETAIL:  The bdr options bdr.skip_ddl_locking and bdr.skip_ddl_replication should only be disabled globally.
HINT:  See the manual for information on these options. Using them without care can break replication.
ERROR:  invalid value for parameter "bdr.skip_ddl_locking": 0
SET bdr.permit_ddl_locking = on;
WARNING:  unsafe BDR configuration options can not be enabled locally
DETAIL:  The bdr options bdr.permit_ddl_locking should only be enabled globally.
HINT:  See the manual for information on these options. Using them without care can break replication.
ERROR:  invalid value for parameter "bdr.permit_ddl_locking": 1
RESET bdr.permit_unsafe_ddl_commands;
RESET bdr.skip_ddl_replication;;
RESET bdr.skip_ddl_locking;
RESET bdr.permit_ddl_locking;
