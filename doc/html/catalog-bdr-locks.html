<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>bdr.bdr_locks</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto: bdr-list@2ndquadrant.com"><LINK
REL="HOME"
TITLE="BDR 2.0.6 Documentation"
HREF="index.html"><LINK
REL="UP"
TITLE="Catalogs and Views"
HREF="catalogs-views.html"><LINK
REL="PREVIOUS"
TITLE="bdr.bdr_conflict_handlers"
HREF="catalog-bdr-conflict-handlers.html"><LINK
REL="NEXT"
TITLE="bdr.bdr_global_locks"
HREF="catalog-bdr-global-locks.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="website-docs.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=ISO-8859-1"><META
NAME="creation"
CONTENT="2023-04-11T13:16:52"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>BDR 2.0.6 Documentation</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="bdr.bdr_conflict_handlers"
HREF="catalog-bdr-conflict-handlers.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="catalogs-views.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>Chapter 13. Catalogs and Views</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="bdr.bdr_global_locks"
HREF="catalog-bdr-global-locks.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CATALOG-BDR-LOCKS"
>13.8. bdr.bdr_locks</A
></H1
><P
>   <TT
CLASS="LITERAL"
>bdr.bdr_locks</TT
> is a view exposing the state of BDR's <A
HREF="catalog-bdr-node-slots.html"
>global DDL locking system</A
>. It can be used to
   diagnose DDL locking problems and monitor the system. Query this view for lock
   state instead of using <A
HREF="catalog-bdr-global-locks.html"
>bdr.bdr_global_locks</A
> directly.
  </P
><P
>   The information in this view is local to each node. It will not necessarily
   be the same on every node in a BDR group. If nothing else, the
   <TT
CLASS="STRUCTFIELD"
>lock_state</TT
> on the node acquiring or holding the
   global DDL lock will always be different to the state on the other nodes.
  </P
><DIV
CLASS="TABLE"
><A
NAME="AEN4182"
></A
><P
><B
>Table 13-7. <TT
CLASS="STRUCTNAME"
>bdr.bdr_locks</TT
> Columns</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><COL><COL><COL><COL><THEAD
><TR
><TH
>Name</TH
><TH
>Type</TH
><TH
>References</TH
><TH
>Description</TH
></TR
></THEAD
><TBODY
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>owner_is_my_node</TT
></TD
><TD
><TT
CLASS="TYPE"
>boolean</TT
></TD
><TD
>&nbsp;</TD
><TD
>True unless another node is known to hold or be acquiring the global DDL lock</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>owner_sysid</TT
></TD
><TD
><TT
CLASS="TYPE"
>text</TT
></TD
><TD
><TT
CLASS="STRUCTNAME"
>bdr.bdr_nodes</TT
><TT
CLASS="STRUCTFIELD"
>.node_sysid</TT
></TD
><TD
>Node identity of the node holding or acquiring the lock</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>owner_timeline</TT
></TD
><TD
><TT
CLASS="TYPE"
>oid</TT
></TD
><TD
><TT
CLASS="STRUCTNAME"
>bdr.bdr_nodes</TT
><TT
CLASS="STRUCTFIELD"
>.node_timeline</TT
></TD
><TD
>Node identity of the node holding or acquiring the lock</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>owner_dboid</TT
></TD
><TD
><TT
CLASS="TYPE"
>oid</TT
></TD
><TD
><TT
CLASS="STRUCTNAME"
>bdr.bdr_nodes</TT
><TT
CLASS="STRUCTFIELD"
>.node_dboid</TT
></TD
><TD
>Node identity of the node holding or acquiring the lock</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>owner_node_name</TT
></TD
><TD
><TT
CLASS="TYPE"
>text</TT
></TD
><TD
><TT
CLASS="STRUCTNAME"
>bdr.bdr_nodes</TT
><TT
CLASS="STRUCTFIELD"
>.node_name</TT
></TD
><TD
>Node name of the node holding or acquiring the lock</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>lock_mode</TT
></TD
><TD
><TT
CLASS="TYPE"
>text</TT
></TD
><TD
>&nbsp;</TD
><TD
>Requested/held lock mode for DDL lock, or null if no locking currently in progress. Current modes are <TT
CLASS="LITERAL"
>ddl_lock</TT
> and <TT
CLASS="LITERAL"
>write_lock</TT
>.</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>lock_state</TT
></TD
><TD
><TT
CLASS="TYPE"
>text</TT
></TD
><TD
>&nbsp;</TD
><TD
>Progress of lock acquisition, explained in breakout below.</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>owner_local_pid</TT
></TD
><TD
><TT
CLASS="TYPE"
>integer</TT
></TD
><TD
>&nbsp;</TD
><TD
>Process ID of backend acquiring lock if the locker is local to the current node. Null if there is no lock or the locker is on a different node. (A future version may report PIDs for remote nodes, so do not rely on this).</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>owner_is_my_backend</TT
></TD
><TD
><TT
CLASS="TYPE"
>boolean</TT
></TD
><TD
>&nbsp;</TD
><TD
>True only if the currently querying backend on the local node is acquiring or holds the lock. A shortcut for testing <TT
CLASS="STRUCTFIELD"
>owner_local_pid</TT
> and <TT
CLASS="STRUCTFIELD"
>owner_node_name</TT
> etc.</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>owner_replorigin</TT
></TD
><TD
><TT
CLASS="TYPE"
>oid</TT
></TD
><TD
><TT
CLASS="STRUCTNAME"
>pg_catalog.pg_replorigin</TT
><TT
CLASS="STRUCTFIELD"
>.oid</TT
></TD
><TD
>Replication origin ID for the node acquiring/holding the lock. You should usually look at the node name or identity tuple instead.</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>lockcount</TT
></TD
><TD
><TT
CLASS="TYPE"
>integer</TT
></TD
><TD
>&nbsp;</TD
><TD
>Number of locks held. Debug parameter. (Always 0 or 1).</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>npeers</TT
></TD
><TD
><TT
CLASS="TYPE"
>integer</TT
></TD
><TD
>&nbsp;</TD
><TD
>Number of nodes known to be participating in locking. Debug parameter.</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>npeers_confirmed</TT
></TD
><TD
><TT
CLASS="TYPE"
>integer</TT
></TD
><TD
>&nbsp;</TD
><TD
>Number of peers for which a confirmation reply has been processed on this node, if lock acquisition is in progress (but not yet complete) and this node is the locker (state <TT
CLASS="LITERAL"
>acquire_tally_confirmations</TT
>). Debug parameter. Will rarely be equal to <TT
CLASS="STRUCTFIELD"
>npeers</TT
> since that successfully concludes a locking request.</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>npeers_declined</TT
></TD
><TD
><TT
CLASS="TYPE"
>integer</TT
></TD
><TD
>&nbsp;</TD
><TD
>Number of peers for which a decline-lock reply has been processed on this node, if lock acquisition is in progress (but not yet complete) and this node is the locker (state <TT
CLASS="LITERAL"
>acquire_tally_confirmations</TT
>). Debug parameter. Likely to always be 0 since one decline terminates a locking request.</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>npeers_replayed</TT
></TD
><TD
><TT
CLASS="TYPE"
>integer</TT
></TD
><TD
>&nbsp;</TD
><TD
>Number of peers that have confirmed successful replay up to <TT
CLASS="REPLACEABLE"
><I
>replay_lsn</I
></TT
> for this node. Node will be in state <TT
CLASS="LITERAL"
>peer_catchup</TT
>.</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>replay_upto</TT
></TD
><TD
><TT
CLASS="TYPE"
>pg_lsn</TT
></TD
><TD
>&nbsp;</TD
><TD
><ACRONYM
CLASS="ACRONYM"
>LSN</ACRONYM
> (Log Sequence Number, i.e. WAL position) of local node up to which peers must replay before they can send replay confirmation. The current replay position can be seen in peer nodes' <TT
CLASS="STRUCTNAME"
>pg_stat_replication</TT
>.<TT
CLASS="STRUCTFIELD"
>replay_location</TT
> entries for this node.</TD
></TR
></TBODY
></TABLE
></DIV
><P
>   See also <A
HREF="ddl-replication.html"
>DDL replication</A
> and <A
HREF="monitoring.html"
>Monitoring</A
>.
   For more information on how global DDL locking works, see <A
HREF="ddl-replication-advice.html#DDL-REPLICATION-LOCKING"
>DDL Locking</A
>.
  </P
><P
>   Possible lock states are:
   <P
></P
></P><UL
><LI
><P
><TT
CLASS="LITERAL"
>nolock</TT
> - There is no locking activity on the node</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>acquire_tally_confirmations</TT
> - This node is acquiring the global DDL lock. <TT
CLASS="STRUCTFIELD"
>owner_local_pid</TT
> contains the pid of the acquiring transaction. It has taken the local DDL lock and has sent lock requests to peers. It is waiting for all peers to respond. The count of peer responses is tallied in <TT
CLASS="STRUCTFIELD"
>npeers_confirmed</TT
>.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>acquire_acquired</TT
> - This node has acquired the global DDL lock. <TT
CLASS="STRUCTFIELD"
>owner_local_pid</TT
> contains the pid of the acquiring transaction. All peers have confirmed that their local locks are acquired.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>peer_begin_catchup</TT
> - This node has just received a lock request from another node that wants to acquire the DDL lock.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>peer_cancel_xacts</TT
> - A peer node wants to acquire the global DDL lock in <TT
CLASS="LITERAL"
>write_lock</TT
> mode. This node is waiting for local write transactions to complete within their grace periods or respond to cancel requests.</P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>peer_catchup</TT
> - A peer node wants to acquire the global DDL lock in <TT
CLASS="LITERAL"
>write_lock</TT
> mode. This node has no local write transactions running. It has sent replay confirmation requests for peers to confirm replay up to lsn <TT
CLASS="STRUCTFIELD"
>replay_upto</TT
> from its peers and is waiting for their responses, which are tallied in <TT
CLASS="STRUCTFIELD"
>npeers_replayed</TT
></P
></LI
><LI
><P
><TT
CLASS="LITERAL"
>peer_confirmed</TT
> - A peer node wants to acquire the global DDL lock. This node has acquired its local DDL lock and sent confirmation to the peer.</P
></LI
></UL
><P>
   These correspond to <TT
CLASS="TYPE"
>BDRLockState</TT
> values in the source code.
  </P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="catalog-bdr-conflict-handlers.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="catalog-bdr-global-locks.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>bdr.bdr_conflict_handlers</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="catalogs-views.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>bdr.bdr_global_locks</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>